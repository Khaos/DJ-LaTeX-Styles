%% -*- Mode: LaTeX Memoir; tab-width: 4;

%% SUACSEThesis.sty    ACSE@SU Thesis
%% !THE TEMPLETE IS BASED ON THE 'MEMOIR' CLASS
%% Created by Dazhi Jiang, 2010-11-16 12:41:58 +0000 (Tue, 16 Nov 2010)

%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
%% * Usage
%%   - 
%%

%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
%% * Change Log
%%   @ 2010-11-16 12:41:58 +0000 (Tue, 16 Nov 2010)
%%     - Create the initial file
%%   @ 2010-11-20 13:33:07 +0000 (Sat, 20 Nov 2010)
%%     - Fix the font options problem, the command, \ProcessPgfPackageOptions,
%%       has to be put somewhere carefully as stated in the code.
%%   @ 2010-12-05 10:07:25 +0000 (Sun,  5 Dec 2010)
%%     - Seperate the pgf-key's definition
%%

%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
%% * TODO
%%   - 
%%

%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
%% Created by Dazhi Jiang, 2010-11-16 16:04:33 +0000 (Tue, 16 Nov 2010)
%% Initialisation
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{SUACSEThesis}[2010/11/16 v0.0.1 SUACSE thesis]

%% ! SUACSEThesis relies on the memoir class
\@ifclassloaded{memoir}{\let\endsuacsethesis\relax}{\let\endsuacsethesis\endinput
  \PackageError{SUACSEThesis}{The SUACSEThesis package only works with the memoir class}{\@ehd}}
\endsuacsethesis

%% END: Initialisation
%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++


%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
%% Created by Dazhi Jiang, 2010-11-16 16:01:56 +0000 (Tue, 16 Nov 2010)
%% Packages
\RequirePackage{pgfkeys}  % Load Package 'pgfkeys'
\RequirePackage{pgfopts}  % Load Package 'pgfopts'

%% END: Packages
%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++


%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
%% Created by Dazhi Jiang, 2010-11-16 18:55:59 +0000 (Tue, 16 Nov 2010)
%% Define Package Keys

%% !!! A few comment
%% The key 'chapterstyle' saves the name of the current chapter style. It can
%% be used by another key, e.g., 'headstyle'. The reason is that some head
%% styles set up the chapter styles as well as the section head ones and
%% therefore they have to be set back to the original one.

%% * Initialisation for the keys
%%   - Initialise the macro required by the keys
\def\@suacse@chapter@style{default}	% Initial chapter style: default

%% * Use '\suacseset' to set-up the suacse keys 
\def\suacseset#1{\pgfkeys{/suacse/.cd,#1}}


% \newcommand*{\setsuacsespacing}[1]{%
%   \let\SUACSESpacing#1
%   \SUACSESpacing}
% \setsuacsespacing{\OnehalfSpacing}

%% END: Define Package Keys
%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++


%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
%% Created by Dazhi Jiang, 2010-12-05 10:19:36 +0000 (Sun,  5 Dec 2010)
%% Spacing

%% * Define spacing-related keys
\pgfkeys{%
	/suacse/.cd,
	%% - Spacing
	spacing/.is choice,
	spacing/single/.code={\SingleSpacing},
	spacing/onehalf/.code={\OnehalfSpacing},
	spacing/double/.code={\DoubleSpacing},
	spacing/.default=onehalf,
	% spacing/.code args={#1 equal to #2}{\if#1}
	spacingfactor/.code={\setSingleSpace{#1} \SingleSpacing},
}

%% * Define spacing-related option keys
\pgfkeys{%
	%% - Spacing
	/suacseopt/.cd,
	spacing/.code={\suacseset{spacing=#1}},
	spacingfactor/.code={\suacseset{spacingfactor=#1}},
}

%% END: Spacing
%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++


%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
%% Created by Dazhi Jiang, 2010-11-16 16:02:34 +0000 (Tue, 16 Nov 2010)
%% Page Layout

%% * Define page-layout-ralated option keys
\pgfkeys{%
	/suacseopt/.cd,
	pagelayout/.is choice,
	pagelayout/asu/.code={\pagelayout@asu},
	pagelayout/memsty/.code={\pagelayout@memsty},
	pagelayout/acsei/.code={\pagelayout@acsei},
	pagelayout/acseii/.code={\pagelayout@acseii},
	% pagelayout/.code={\suacseset{pagelayout=#1}},
}

%% * Some useful lengths for layout purposes
\newlength{\toptafiddle}
\newlength{\bottafiddle}
\newlength{\topfiddle}
\newlength{\botfiddle}
\newlength{\linespace}

%% * ASU page layout
% \renewcommand{\pagelayout@asu}{%
\newcommand{\pagelayout@asu}{%
	%% * set up margins for a4paper stock
	%%   - left, right and textwidth
	\setlrmarginsandblock{1.5in}{1in}{*}

	%% for main body
	%% bottom of text at 1in, footer below
	%% top of header at 1in, first text line double spaced below base of header
	\setlength{\linespace}{\baselineskip} %% the current equivalent of \onelineskip
	\setlength{\headheight}{\onelineskip}
	\setlength{\headsep}{\linespace}
	\addtolength{\headsep}{-\topskip}
	\setlength{\uppermargin}{1in}
	\addtolength{\uppermargin}{\headheight}
	\addtolength{\uppermargin}{\headsep}
	\setlength{\lowermargin}{1in}
	\setlength{\footskip}{\onelineskip}
	\setlength{\textheight}{\paperheight}
	\addtolength{\textheight}{-\uppermargin}
	\addtolength{\textheight}{-\lowermargin}
	%% the fiddle lengths (..ta.. for title/approval page, others for prelims)
	%% (determined by many trials and errors)
	\setlength{\toptafiddle}{2\linespace}
	\setlength{\topfiddle}{\toptafiddle}
	\setlength{\bottafiddle}{\onelineskip}
	\setlength{\botfiddle}{0pt} % actually this is not used

	\checkandfixthelayout[nearest]
}
\@onlypreamble\pagelayout@asu

%% * memsty page layout
% \renewcommand{\pagelayout@memsty}{%
\newcommand{\pagelayout@memsty}{%
	%% set up the page layout
	\settrimmedsize{11in}{210mm}{*}
	\setlength{\trimtop}{0pt}
	\setlength{\trimedge}{\stockwidth}
	\addtolength{\trimedge}{-\paperwidth}
	\settypeblocksize{7.75in}{33pc}{*}
	\setulmargins{4cm}{*}{*}
	\setlrmargins{1.25in}{*}{*}
	\setmarginnotes{17pt}{51pt}{\onelineskip}
	\setheadfoot{\onelineskip}{2\onelineskip}
	\setheaderspaces{*}{2\onelineskip}{*}
	\setsidefeet{\marginparsep}{9em}%
	   {\onelineskip}{0pt}%
	   {\normalfont\footnotesize}{\textheight}%
	\checkandfixthelayout
}
\@onlypreamble\pagelayout@memsty

%% * ACSE page layout I
% \renewcommand{\pagelayout@acsei}{%
\newcommand{\pagelayout@acsei}{%
	%% * set up margins for a4paper stock
	%%   - left, right and textwidth
	\setlrmarginsandblock{1.5in}{1.2in}{*}

	%% for main body
	%% bottom of text at 1in, footer below
	%% top of header at 1in, first text line double spaced below base of header
	\setlength{\linespace}{\baselineskip} %% the current equivalent of \onelineskip
	\setlength{\headheight}{\onelineskip}
	\setlength{\headsep}{\linespace}
	\addtolength{\headsep}{-\topskip}
	\setlength{\uppermargin}{1.2in}
	\addtolength{\uppermargin}{\headheight}
	\addtolength{\uppermargin}{\headsep}
	\setlength{\lowermargin}{1.2in}
	\setlength{\footskip}{\onelineskip}
	\setlength{\textheight}{\paperheight}
	\addtolength{\textheight}{-\uppermargin}
	\addtolength{\textheight}{-\lowermargin}
	%% the fiddle lengths (..ta.. for title/approval page, others for prelims)
	%% (determined by many trials and errors)
	\setlength{\toptafiddle}{2\linespace}
	\setlength{\topfiddle}{\toptafiddle}
	\setlength{\bottafiddle}{\onelineskip}
	\setlength{\botfiddle}{0pt} % actually this is not used

	\checkandfixthelayout[nearest]
}
\@onlypreamble\pagelayout@acsei

%% * ACSE page layout II
% \renewcommand{\pagelayout@acseii}{%
\newcommand{\pagelayout@acseii}{%
	%% set up the page layout%
	%% \settrimmedsize is incompatible with the command,
	%%   \AtBeginDocument{\usepackage{graphicx}}
	%% which is included in the package 'mathtools'.
	% \settrimmedsize{11in}{210mm}{*} % a4paper: 297mm * 210mm%
	\setlength{\trimtop}{0pt}
	\setlength{\trimedge}{\stockwidth}
	\addtolength{\trimedge}{-\paperwidth}
	\settypeblocksize{8.5in}{31pc}{*}
	\setulmargins{4.5cm}{*}{*}
	\setlrmargins{1.8in}{*}{*}
	\setmarginnotes{17pt}{51pt}{\onelineskip}
	\setheadfoot{\onelineskip}{2\onelineskip}
	\setheaderspaces{*}{2\onelineskip}{*}
	\setsidefeet{\marginparsep}{9em}%
	   {\onelineskip}{0pt}%
	   {\normalfont\footnotesize}{\textheight}%
	\setlength{\footskip}{\onelineskip}
	\setlength{\footnotesep}{\onelineskip}
	\checkandfixthelayout
	% \fixpdflayout
}
\@onlypreamble\pagelayout@acseii

% \renewcommand{\pagelayout@acseii}{}
% \newcommand{\pagelayout@acseii}{}


%% END: Page Layout
%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++


%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
%% Created by Dazhi Jiang, 2010-11-16 16:03:55 +0000 (Tue, 16 Nov 2010)
%% Page Styles
%%   * \markboth takes the effect for the twosides documents, while \markright
%%     is used for the oneside documents.


%% * Define page-style-related keys
\pgfkeys{%
	/suacse/.cd,
	%% - Page style
	loadpagestyle/.is choice,
	loadpagestyle/asu/.code={\suacse@loadpagestyle@asu},
	loadpagestyle/wspr/.code={\suacse@loadpagestyle@wspr},
	loadpagestyle/acsei/.code={\suacse@loadpagenumberstyle
							   \suacse@loadpagestyle@acsei},
	pagestyle/.code={\pagestyle{#1}},
}

%% * Define page-style-related option keys



%% * Declare the style switchers for page number
\newif\if@suacse@page@numbering@style@default
\newif\if@suacse@page@numbering@style@plain
\newif\if@suacse@page@numbering@style@bold
\newif\if@suacse@page@numbering@style@largebold
\newif\if@suacse@page@numbering@style@blackbg
\newif\if@suacse@page@numbering@style@bari
\newif\if@suacse@page@numbering@style@acsei

\newcommand*{\@suacse@switch@page@numbering@off}{%
	\@suacse@page@numbering@style@defaultfalse
	\@suacse@page@numbering@style@plainfalse
	\@suacse@page@numbering@style@boldfalse
	\@suacse@page@numbering@style@largeboldfalse
	\@suacse@page@numbering@style@blackbgfalse
	\@suacse@page@numbering@style@barifalse
	\@suacse@page@numbering@style@acseifalse
}

%% * Define page-number-style-related keys
%%   ! The 'pagenumberstyle' key has to be set up before any \pagestyle
%%     command.
\pgfkeys{%
	/suacse/.cd,
	%% - Page number style
	pagenumberstyle/.is choice,
	pagenumberstyle/default/.code={\@suacse@switch@page@numbering@off
							\@suacse@page@numbering@style@defaulttrue},
	pagenumberstyle/plain/.code={\@suacse@switch@page@numbering@off
							\@suacse@page@numbering@style@plaintrue},
	pagenumberstyle/bold/.code={\@suacse@switch@page@numbering@off
							\@suacse@page@numbering@style@boldtrue},
	pagenumberstyle/largebold/.code={\@suacse@switch@page@numbering@off
							\@suacse@page@numbering@style@largeboldtrue},
	pagenumberstyle/blackbg/.code={\@suacse@switch@page@numbering@off
							\@suacse@page@numbering@style@blackbgtrue},
	pagenumberstyle/bari/.code={\@suacse@switch@page@numbering@off
							\@suacse@page@numbering@style@baritrue},
	pagenumberstyle/acsei/.code={\@suacse@switch@page@numbering@off
							\@suacse@page@numbering@style@acseitrue},
	pagenumberstyle/.default=default,
}


%% * Define page-number style
%%   ! The following styles are only available when ACSE page styles are used.
\newcommand{\suacse@loadpagenumberstyle}{%
	%% - Load required package
	\RequirePackage[svgnames]{xcolor}  % Load Package 'xcolor'
	\RequirePackage{tikz}  % Load Package 'tikz'
	% \providecommand\thesispage{\normalfont p.\,\thepage}
	% \providecommand\thesispage{\normalfont \colorbox{black}%
	% 		{\color{white}p.\,\thepage}}
	%% - Default style: number only
	\@ifundefined{@suacse@pagenumber@font}%
		{\newcommand*{\@suacse@pagenumber@font}{\normalfont}}
		{\renewcommand*{\@suacse@pagenumber@font}{\normalfont}}
	\@ifundefined{@suacse@pagenumber@text}%
		{\newcommand*{\@suacse@pagenumber@text}{\thepage}}
		{\renewcommand*{\@suacse@pagenumber@text}{\thepage}}
	\@ifundefined{@suacse@pagenumber}%
		{\newcommand{\@suacse@pagenumber}%
			{\@suacse@pagenumber@font\@suacse@pagenumber@text}}{}
	\if@suacse@page@numbering@style@default
		\renewcommand*{\@suacse@pagenumber@font}{\normalfont}
		\renewcommand*{\@suacse@pagenumber@text}{\thepage}
	\fi
	%% - Plain style
	\if@suacse@page@numbering@style@plain
		\renewcommand{\@suacse@pagenumber@text}{%
			\if@mainmatter
				p.\,\thepage
			\else
				\thepage
			\fi
		}
	\fi
	%% - Bold style
	\if@suacse@page@numbering@style@bold
		\renewcommand{\@suacse@pagenumber@font}{\normalfont\bfseries}
	\fi
	%% - Large-bold style
	\if@suacse@page@numbering@style@largebold
		\renewcommand{\@suacse@pagenumber@font}{\normalfont\large\bfseries}
	\fi
	%% - Black-background style
	\if@suacse@page@numbering@style@blackbg
		\renewcommand{\@suacse@pagenumber@font}{\normalfont\bfseries}
		\renewcommand{\@suacse@pagenumber@text}{%
			\if@mainmatter
				p.\,\thepage
			\else
				\thepage
			\fi
		}
		\renewcommand{\@suacse@pagenumber}{\@suacse@pagenumber@font %
			\tikz [baseline=0pt]
			\node [preaction={draw=black, line width=2.5pt}]
				  [draw=lightgray,
				   line width=0.5pt,
				   fill=black!100,
				   text=white,
				   anchor=base,
				   rounded corners=2pt,
				   minimum height=1.5em,
				   minimum width=2em]		{\@suacse@pagenumber@text};
		}
	\fi
	%% - Bar style I
	\if@suacse@page@numbering@style@bari
		\renewcommand{\@suacse@pagenumber@font}{\normalfont\bfseries}
		\renewcommand{\@suacse@pagenumber@text}{\thepage}
		\renewcommand{\@suacse@pagenumber}{\@suacse@pagenumber@font %
			\if@mainmatter
				\@suacse@pagenumber@text\;%
				\tikz [baseline=0pt]{%[baseline=(current bounding box.south)]
				\path [use as bounding box] (0, 0) rectangle (1.5mm, 2ex);
				% \filldraw[anchor=base] (0,0) rectangle (2mm, 2.5ex); \;\thepage
				\filldraw [anchor=base,
						   gray] (0,-1mm) rectangle (1.5mm, 1.8ex);}
			\else
				\@suacse@pagenumber@text%
				% \;%
				% \tikz [baseline=0pt]{%[baseline=(current bounding box.south)]
				% \path [use as bounding box] (0, 0) rectangle (2mm, 2ex);
				% % \filldraw[anchor=base] (0,0) rectangle (2mm, 2.5ex); \;\thepage
				% \path [anchor=base] (0,-1mm) rectangle (1.5mm, 1.8ex);}
			\fi
		}
	\fi
	%% - ACSE style I
	\if@suacse@page@numbering@style@acsei
		\renewcommand{\@suacse@pagenumber@font}{\normalfont\bfseries}
		\renewcommand{\@suacse@pagenumber@text}{%
			\if@mainmatter
				p.\,\thepage
			\else
				\thepage
			\fi
		}
		\renewcommand{\@suacse@pagenumber}{\@suacse@pagenumber@font %
			\tikz [baseline=0pt]
			\node [anchor=base,
				   rounded corners=2pt,
				   minimum height=1.5em,
				   minimum width=2em]		{\@suacse@pagenumber@text};
		}
	\fi
}


%% * ASU thesis page style
% \renewcommand{\suacse@loadpagestyle@asu}{%
\newcommand{\suacse@loadpagestyle@asu}{%
	%% - Main text
	\makepagestyle{asu}
	  \makeevenhead{asu}{\thepage}{}{}
	  \makeoddhead{asu}{}{}{\thepage}
	%% - For continuation pages of the ToC, LoF, LoT
	\makepagestyle{toc}
	  \makeevenfoot{toc}{}{\thepage}{}
	  \makeoddfoot{toc}{}{\thepage}{}
	  \makeevenhead{toc}{Chapter}{}{Page}
	  \makeoddhead{toc}{Chapter}{}{Page}
	\makepagestyle{lof}
	  \makeevenfoot{lof}{}{\thepage}{}
	  \makeoddfoot{lof}{}{\thepage}{}
	  \makeevenhead{lof}{Figure}{}{Page}
	  \makeoddhead{lof}{Figure}{}{Page}
	\makepagestyle{lot}
	  \makeevenfoot{lot}{}{\thepage}{}
	  \makeoddfoot{lot}{}{\thepage}{}
	  \makeevenhead{lot}{Table}{}{Page}
	  \makeoddhead{lot}{Table}{}{Page}
	%% Use \pagestyle{plain} for prelims
}

%% * Will Robertson's page thesis style
% \renewcommand{\suacse@loadpagestyle@wspr}{%
\newcommand{\suacse@loadpagestyle@wspr}{%
	\if@twoside
		% 
	\else
		\setlength{\headheight}{\baselineskip}
		\setlength{\headwidth}{\textwidth+\marginparsep+0.5\marginparwidth}
		\makepagestyle{wspr}
		\makepsmarks{wspr}{%
		  % \let\@mkboth\markboth%
		  \def\chaptermark####1{%
		    \markright{%
		      \if@mainmatter
		        \textsc{Chapter \thechapter:} %
		      \fi
		      ####1}}%
		  \def\sectionmark####1{%
		    \markright{%
		      \if@mainmatter
		        \textsc{\S\thesection:} %
		      \fi
		      ####1}}}
		\makerunningwidth{wspr}{\headwidth}
		\makeheadposition{wspr}{flushright}{flushleft}{}{}
		\makeevenhead{wspr}{\makebox[0pt][c]{\thesispage}} {} {\small\leftmark}
		\makeoddhead{wspr} {\small\rightmark}              {} {\thesispage}
		% \makeheadrule{wspr}{\headwidth}{0.5pt}
	\fi
}

%% * ACSE thesis page style I
%%   - Load page style
% \renewcommand{\suacse@loadpagestyle@acsei}{%
\newcommand{\suacse@loadpagestyle@acsei}{%
	\if@twoside
		\makepagestyle{acsei}
		  \makepsmarks{acsei}{%
		    % \let\@mkboth\markboth%
		    \def\chaptermark####1{%
		      \markboth{%
		        \if@mainmatter
		          % \textsc{\S\thechapter:} %
		          \textsc{Chapter\ \thechapter:} %
		        \fi
		        ####1}{####1}}%
		    \def\sectionmark####1{%
		      \markright{%
		        \if@mainmatter
		          \textsc{\S\thesection:} %
		        \fi
		        ####1}}}
		  \makeevenhead{acsei}{\makebox[0pt][c]{\@suacse@pagenumber}} {} {\small\leftmark}
		  \makeoddhead{acsei} {\small\rightmark}              {} {\@suacse@pagenumber}
		  \setlength{\headwidth}{\textwidth}
		  \makeheadrule{acsei}{\headwidth}{0.4pt}
	\else
		\setlength{\headheight}{\baselineskip}
		% \setlength{\headwidth}{\textwidth}
		\setlength{\headwidth}{\textwidth+\marginparsep+0.4\marginparwidth}
		\makepagestyle{acsei}
		  \makepsmarks{acsei}{%
		    % \let\@mkboth\markboth%
		    \def\chaptermark####1{%
		      \markright{%
		        \if@mainmatter
		          % \textsc{\S\thechapter:} %
		          \textsc{Chapter\ \thechapter:} %
		        \fi
		        ####1}}%
		    \def\sectionmark####1{%
		      \markright{%
		        \if@mainmatter
		          \textsc{\S\thesection:} %
		        \fi
		        ####1}}}
		  % \makerunningwidth{acsei}{\headwidth}
		  \makerunningwidth{acsei}[\headwidth]{\textwidth}
		  \makeheadposition{acsei}{flushright}{flushleft}{}{}
		  % \if@mainmatter
		    \makeevenhead{acsei}{\makebox[0pt][c]{\@suacse@pagenumber}} {} {\small\leftmark}
		    \makeoddhead{acsei} {\small\rightmark}              {} {\@suacse@pagenumber}
		  % \else
		  %   \makeevenhead{acsei}{\makebox[0pt][c]{\thepage}} {} {\small\leftmark}
		  %   \makeoddhead{acsei} {\small\rightmark}              {} {\thepage}
		  % \fi
		  % \setlength{\headwidth}{\textwidth}
		  % \makeheadrule{acsei}{\headwidth}{0.4pt}
		  \makeheadrule{acsei}{\textwidth}{0.4pt}
		
		% \if@mainmatter
		% \setlength{\headwidth}{\textwidth+\marginparsep+0.4\marginparwidth}
		\makerunningwidth{plain}{\headwidth}
		% \makerunningwidth{plain}[\headwidth]{\textwidth}
		\makeheadposition{plain}{flushright}{flushleft}{flushright}{flushleft}
		\makeoddfoot{plain}{}{}{\@suacse@pagenumber}
		% \else
		% \makeoddfoot{plain}{}{}{\thepage}
		% \fi
	\fi
}

%% Pagestyle: headings, demo codes from the memoir class
% \if@twoside
%   \makepagestyle{headings}
%     \makepsmarks{headings}{%
%       \def\chaptermark##1{%
%         \markboth{\memUChead{%
%           \ifnum \c@secnumdepth >\m@ne
%             \if@mainmatter
%               \@chapapp\ \thechapter. \ %
%             \fi
%           \fi
%           ##1}}{}}%
%       \def\tocmark{\markboth{\memUChead{\contentsname}}{\memUChead{\contentsname}}}%
%       \def\lofmark{\markboth{\memUChead{\listfigurename}}{\memUChead{\listfigurename}}}%
%       \def\lotmark{\markboth{\memUChead{\listtablename}}{\memUChead{\listtablename}}}%
%       \def\bibmark{\markboth{\memUChead{\bibname}}{\memUChead{\bibname}}}%
%       \def\indexmark{\markboth{\memUChead{\indexname}}{\memUChead{\indexname}}}%
%       \def\sectionmark##1{%
%         \markright{\memUChead{%
%           \ifnum \c@secnumdepth > \z@
%             \thesection. \ %
%           \fi
%           ##1}}}}
%     \makepsmarks{headings}{%
%       \createmark{chapter}{left}{shownumber}{\@chapapp\ }{. \ }
%       \createmark{section}{right}{shownumber}{}{. \ }
%       \createplainmark{toc}{both}{\contentsname}
%       \createplainmark{lof}{both}{\listfigurename}
%       \createplainmark{lot}{both}{\listtablename}
%       \createplainmark{bib}{both}{\bibname}
%       \createplainmark{index}{both}{\indexname}
%       \createplainmark{glossary}{both}{\glossaryname}
%     }
%     \makeevenhead{headings}{\thepage}{}{\slshape\leftmark}
%     \makeoddhead{headings}{\slshape\rightmark}{}{\thepage}
% \else
%   \makepagestyle{headings}
%     \makepsmarks{headings}{%
%       \def\chaptermark##1{%
%         \markright{\memUChead{%
%           \ifnum \c@secnumdepth >\m@ne
%             \if@mainmatter
%               \@chapapp\ \thechapter. \ %
%             \fi
%           \fi
%           ##1}}}%
%       \def\tocmark{\markright{\memUChead{\contentsname}}}%
%       \def\lofmark{\markright{\memUChead{\listfigurename}}}%
%       \def\lotmark{\markright{\memUChead{\listtablename}}}%
%       \def\bibmark{\markright{\memUChead{\bibname}}}%
%       \def\indexmark{\markright{\memUChead{\indexname}}}}
%     \makepsmarks{headings}{%
%       \createmark{chapter}{right}{shownumber}{\@chapapp\ }{. \ }
%       \createplainmark{toc}{right}{\contentsname}
%       \createplainmark{lof}{right}{\listfigurename}
%       \createplainmark{lot}{right}{\listtablename}
%       \createplainmark{bib}{right}{\bibname}
%       \createplainmark{index}{right}{\indexname}
%       \createplainmark{glossary}{right}{\glossaryname}
%     }
%     \makeoddhead{headings}{\slshape\rightmark}{}{\thepage}
% \fi

%% END: Page Styles
%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++


%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
%% Created by Dazhi Jiang, 2010-11-16 16:10:39 +0000 (Tue, 16 Nov 2010)
%% TOC etc.

%% * Set the default TOC depth
\maxtocdepth{subsection}    % include subsections in ToC

%% * Declare switchers for TOC
\newif\ifsuacse@toc@short@show
\newif\ifsuacse@toc@style@memsty
\newif\ifsuacse@toc@style@wspr
\newif\ifsuacse@toc@style@acsei

%% * Define TOC-related keys
\pgfkeys{%
	/suacse/.cd,
	%% - TOC
	showshorttoc/.is if=suacse@toc@short@show,
	showshorttoc/.default=false,
	tocstyle@memsty/.is if=suacse@toc@style@memsty,
	tocstyle@wspr/.is if=suacse@toc@style@wspr,
	tocstyle@acsei/.is if=suacse@toc@style@acsei,
	loadtocstyle/.is choice,
	loadtocstyle/memsty/.style={tocstyle@memsty=true,%
								tocstyle@wspr=false,%
								tocstyle@acsei=false,},
	loadtocstyle/wspr/.style={tocstyle@memsty=false,%
							  tocstyle@wspr=true,%
							  tocstyle@acsei=false,},
	loadtocstyle/acsei/.style={tocstyle@memsty=false,%
							   tocstyle@wspr=false,%
							   tocstyle@acsei=true,},
	loadtocstyle/.default=acsei,
	loadtocstyle/.append code={\suacse@loadtocstyle},
	tocstyle/.style={loadtocstyle=#1},
	tocdepth/.code={\settocdepth{#1}},
	maxtocdepth/.code={\maxtocdepth{#1}},
}

%% * Define TOC-related option keys


%% * Load TOC styles

%%   - Switcher required by style
\newif\if@shorttoc

%%   - Pre-defined command
%%     Hide content line in short toc
\newenvironment {hideshorttoc} {
  \addtocontents{toc}{ \protect\if@shorttoc \protect\else }
}{
  \addtocontents{toc}{ \protect\fi }
}


\newcommand{\suacse@loadtocstyle}{%
%% * Memsty style
\ifsuacse@toc@style@memsty
	%% - Define short TOC
	\newcommand*{\setupshorttoc}{%
	  \@shorttoctrue
	  \renewcommand*{\contentsname}{Short contents}
	  \let\oldchangetocdepth\changetocdepth
	  \let\oldprecistoctext\precistoctext
	  \renewcommand{\precistoctext}[1]{}
	  \let\oldcftchapterfillnum\cftchapterfillnum
	  \renewcommand*{\changetocdepth}[1]{}
	  \setcounter{tocdepth}{0}% chapters
	  % \renewcommand*{\cftpartfont}{\hfill\sffamily}
	  % \renewcommand*{\cftpartpagefont}{\normalfont}
	  % \renewcommand*{\cftpartleader}{ \textperiodcentered\space}
	  % \renewcommand*{\cftpartafterpnum}{\cftparfillskip}
	  \renewcommand*{\cftchapterfont}{\hfill\sffamily}
	  \renewcommand*{\cftchapterpagefont}{\normalfont}
	  \renewcommand*{\cftchapterleader}{ \textperiodcentered\space}
	  \renewcommand*{\cftchapterafterpnum}{\cftparfillskip}
	  % \setpnumwidth{0em}
	  % \setpnumwidth{1.5em}
	  \renewcommand*{\cftchapterfillnum}[1]{%
	    {\cftchapterleader}\nobreak
	    \hbox to 1.5em{\cftchapterpagefont ####1\hfil}\cftchapterafterpnum\par}
	  \setrmarg{0.3\textwidth}
	  \setlength{\unitlength}{\@tocrmarg}
	  \addtolength{\unitlength}{1.5em}
	  \let\oldcftpartformatpnum\cftpartformatpnum
	  \renewcommand*{\cftpartformatpnum}[1]{%
	    \hbox to\unitlength{{\cftpartpagefont ####1}}}
	  \let\oldcftbookformatpnum\cftbookformatpnum
	  \renewcommand*{\cftbookformatpnum}[1]{%
	    \hbox to\unitlength{{\cftbookpagefont ####1}}}}

	\newcommand*{\setupparasubsecs}{%
	  \@shorttocfalse
	  \let\oldnumberline\numberline
	  \renewcommand*{\cftsubsectionfont}{\itshape}
	  \renewcommand*{\cftsubsectionpagefont}{\itshape}
	  \renewcommand{\l@subsection}[2]{
	    \ifnum\c@tocdepth > 1\relax
	      \def\numberline########1{\textit{########1}~}%
	      \leftskip=\cftsubsectionindent
	      \rightskip=\@tocrmarg
	      % \advance\rightskip 0pt plus \hsize % uncomment this for raggedright
	      % \advance\rightskip 0pt plus 2em    % uncomment this for semi-ragged
	      \parfillskip=\fill
	      \ifhmode ,\ \else\noindent\fi
	      \ignorespaces 
	      {\cftsubsectionfont ####1}~{\cftsubsectionpagefont####2}%
	       \let\numberline\oldnumberline\ignorespaces
	    \fi}}

	\AtEndDocument{\addtocontents{toc}{\par}}%%% OK

	%%   - Define long TOC
	\newcommand*{\setupmaintoc}{%
	  \renewcommand{\contentsname}{Contents}
	  \let\changetocdepth\oldchangetocdepth
	  \let\precistoctext\oldprecistoctext
	  \let\cftchapterfillnum\oldcftchapterfillnum
	  \addtodef{\cftchapterbreak}{\par}{}
	  \renewcommand*{\cftchapterfont}{\normalfont\sffamily}
	  \renewcommand*{\cftchapterleader}{\sffamily\cftdotfill{\cftchapterdotsep}}
	  \renewcommand*{\cftchapterafterpnum}{}
	  \renewcommand{\cftchapterbreak}{\par\addpenalty{-\@highpenalty}}
	  \setpnumwidth{2.55em}
	  \setrmarg{3.55em}
	  \setcounter{tocdepth}{2}
	  \let\cftpartformatpnum\oldcftpartformatpnum
	  \addtodef{\cftpartbreak}{\par}{}
	  \let\cftbookformatpnum\oldcftbookformatpnum
	  \addtodef{\cftbookbreak}{\par}{}
	}
\fi

%% * Will Robertson's style
\ifsuacse@toc@style@wspr
	\newcommand*{\setupshorttoc}{%
	  \@shorttoctrue
	  \renewcommand*{\contentsname}{Short contents}
	  \let\oldchangetocdepth\changetocdepth
	  \renewcommand{\precistoctext}[1]{%
	    \nobreak
	    \begin{quote}
	      \leftskip    = 0cm plus  0.5fil
	      \rightskip   = 0cm plus -0.5fil
	      \parfillskip = 0cm plus    1fil
	      \footnotesize ####1
	    \end{quote}
	  }
	  \let\oldcftchapterfillnum\cftchapterfillnum
	  \renewcommand*{\changetocdepth}[1]{}
	  \setcounter{tocdepth}{0}% chapters
	  %
	  \renewcommand*{\cftchapterfont}{\hfill}
	  \renewcommand*{\cftchapterfillnum}[1]{%
	    \quad \nobreak p.\,####1\hfill \null \par
	  }
	  %
	  \renewcommand*{\cftpartfont}{\hfill \bfseries}
	  \renewcommand*{\cftpartfillnum}[1]{\hfill\null\par}
	}

	\newcommand*{\setupparasubsecs}{%
	  \@shorttocfalse
	  \let\oldnumberline\numberline
	  \renewcommand \cftsubsectionfont     {\small}
	  \renewcommand \cftsubsectionpagefont {\upshape\small}
	  \renewcommand \l@subsection [2] {%
	    \ifnum\c@tocdepth > 1
	      \def\numberline########1{\parsesubsection########1\@nil}%
	      \leftskip=\cftsubsectionindent
	      \rightskip=\@tocrmarg
	      \advance\rightskip 0pt plus 2em
	      \parfillskip=\fill
	      \ifhmode
	        \unskip\unskip\unskip\unskip\unskip\unskip\unskip\unskip \unskip\unskip\unskip\unskip\unskip\unskip\unskip\unskip\,,\space
	      \else
	        \noindent
	      \fi
	      \ignorespaces
	      {\cftsubsectionfont ####1}~{\cftsubsectionpagefont####2}%
	       \let\numberline\oldnumberline\expandafter\ignorespaces
	    \fi
	  }%
	}

	\def\parsesubsection##1.##2.##3\@nil{##3 \itshape}

	\AtEndDocument{\addtocontents{toc}{\par}}%%% OK

	\newcommand*{\setupmaintoc}{%
	  \renewcommand{\contentsname}{Contents}
	  \let\changetocdepth\oldchangetocdepth
	  \renewcommand{\precistoctext}[1]{}
	  \let\cftchapterfillnum\oldcftchapterfillnum
	  \addtodef{\cftchapterbreak}{\par}{}
	  \renewcommand*{\cftchapterfont}{\normalfont}
	  \renewcommand*{\cftchapterleader}{\cftdotfill{\cftchapterdotsep}}
	  \renewcommand*{\cftchapterafterpnum}{}
	  \renewcommand{\cftchapterbreak}{\par\addpenalty{-\@highpenalty}}
	  \setpnumwidth{2.55em}
	  \setrmarg{3.55em}
	  \setcounter{tocdepth}{2}
	  \let\cftpartformatpnum\oldcftpartformatpnum
	  \addtodef{\cftpartbreak}{\par}{}
	  \let\cftbookformatpnum\oldcftbookformatpnum
	  \addtodef{\cftbookbreak}{\par}{}
	}

	\renewcommand\chapterprecistoc[1]{%
	  \addtocontents{toc}{\protect\precistoctext{##1}}%
	}

	\renewcommand\chapterprecishere[1]{}

\fi

%% * ACSE style I
\ifsuacse@toc@style@acsei
	%% - Define short TOC
	\newcommand*{\setupshorttoc}{%
	  \@shorttoctrue
	  \renewcommand*{\contentsname}{Short contents}
	  \let\oldchangetocdepth\changetocdepth
	  \let\oldprecistoctext\precistoctext
	  \renewcommand{\precistoctext}[1]{}
	  \let\oldcftchapterfillnum\cftchapterfillnum
	  \renewcommand*{\changetocdepth}[1]{}
	  \setcounter{tocdepth}{0}% chapters
	  % \renewcommand*{\cftpartfont}{\hfill\sffamily}
	  % \renewcommand*{\cftpartpagefont}{\normalfont}
	  % \renewcommand*{\cftpartleader}{ \textperiodcentered\space}
	  % \renewcommand*{\cftpartafterpnum}{\cftparfillskip}
	  \renewcommand*{\cftchapterfont}{\hfill\sffamily}
	  \renewcommand*{\cftchapterpagefont}{\normalfont}
	  \renewcommand*{\cftchapterleader}{ \textperiodcentered\space}
	  \renewcommand*{\cftchapterafterpnum}{\cftparfillskip}
	  % \setpnumwidth{0em}
	  % \setpnumwidth{1.5em}
	  \renewcommand*{\cftchapterfillnum}[1]{%
	    {\cftchapterleader}\nobreak
	    \hbox to 1.5em{\cftchapterpagefont ####1\hfil}\cftchapterafterpnum\par}
	  \setrmarg{0.3\textwidth}
	  \setlength{\unitlength}{\@tocrmarg}
	  \addtolength{\unitlength}{1.5em}
	  \let\oldcftpartformatpnum\cftpartformatpnum
	  \renewcommand*{\cftpartformatpnum}[1]{%
	    \hbox to\unitlength{{\cftpartpagefont ####1}}}
	  \let\oldcftbookformatpnum\cftbookformatpnum
	  \renewcommand*{\cftbookformatpnum}[1]{%
	    \hbox to\unitlength{{\cftbookpagefont ####1}}}}

	\newcommand*{\setupparasubsecs}{%
	  \@shorttocfalse
	  \let\oldnumberline\numberline
	  \renewcommand*{\cftsubsectionfont}{\itshape}
	  \renewcommand*{\cftsubsectionpagefont}{\itshape}
	  \renewcommand{\l@subsection}[2]{
	    \ifnum\c@tocdepth > 1\relax
	      \def\numberline########1{\textit{########1}~}%
	      \leftskip=\cftsubsectionindent
	      \rightskip=\@tocrmarg
	      % \advance\rightskip 0pt plus \hsize % uncomment this for raggedright
	      % \advance\rightskip 0pt plus 2em    % uncomment this for semi-ragged
	      \parfillskip=\fill
	      \ifhmode ,\ \else\noindent\fi
	      \ignorespaces 
	      {\cftsubsectionfont ####1}~{\cftsubsectionpagefont####2}%
	       \let\numberline\oldnumberline\ignorespaces
	    \fi}}

	\AtEndDocument{\addtocontents{toc}{\par}}%%% OK

	%%   - Define long TOC
	\newcommand*{\setupmaintoc}{%
	  \renewcommand{\contentsname}{Contents}
	  \let\changetocdepth\oldchangetocdepth
	  \let\precistoctext\oldprecistoctext
	  \let\cftchapterfillnum\oldcftchapterfillnum
	  \addtodef{\cftchapterbreak}{\par}{}
	  \renewcommand*{\cftchapterfont}{\normalfont\sffamily}
	  \renewcommand*{\cftchapterleader}{\sffamily\cftdotfill{\cftchapterdotsep}}
	  \renewcommand*{\cftchapterafterpnum}{}
	  \renewcommand{\cftchapterbreak}{\par\addpenalty{-\@highpenalty}}
	  \setpnumwidth{2.55em}
	  \setrmarg{3.55em}
	  \setcounter{tocdepth}{2}
	  \let\cftpartformatpnum\oldcftpartformatpnum
	  \addtodef{\cftpartbreak}{\par}{}
	  \let\cftbookformatpnum\oldcftbookformatpnum
	  \addtodef{\cftbookbreak}{\par}{}
	}
\fi

}

%% * Show TOC
\newcommand{\printtoc}{%
\ifsuacse@toc@short@show
	\setupshorttoc
	\tableofcontents
	\clearpage
\fi
\setupparasubsecs
\setupmaintoc
\tableofcontents
\clearpage
}


%% END: TOC etc.
%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++


%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
%% Created by Dazhi Jiang, 2010-11-16 16:10:58 +0000 (Tue, 16 Nov 2010)
%% Chapter Styling

%% * Declare switchers for the extra chapter styles
\newif\ifsuacse@chapterstyle@daleifi
\newif\ifsuacse@chapterstyle@GreyNum
\newif\ifsuacse@chapterstyle@texblogtikz
\newif\ifsuacse@chapterstyle@acsei

%% * Define chapter-style-related keys
\pgfkeys{%
	/suacse/.cd,
	%% - Chapter style
	chapterstyle/.code={\chapterstyle{#1}
						\def\@suacse@chapter@style{#1}},
	chapterstyle@daleifi/.is if=suacse@chapterstyle@daleifi,
	chapterstyle@GreyNum/.is if=suacse@chapterstyle@GreyNum,
	chapterstyle@texblogtikz/.is if=suacse@chapterstyle@texblogtikz,
	chapterstyle@acsei/.is if=suacse@chapterstyle@acsei,
	loadextrachapsty/.is choice,
	loadextrachapsty/all/.style={chapterstyle@daleifi=true,%
								 chapterstyle@GreyNum=true,%
								 chapterstyle@texblogtikz=true,%
								 chapterstyle@acsei=true},
	loadextrachapsty/daleifi/.style={chapterstyle@daleifi=true,%
									 chapterstyle@GreyNum=false,%
									 chapterstyle@texblogtikz=false,%
					 				 chapterstyle@acsei=false},
	loadextrachapsty/GreyNum/.style={chapterstyle@daleifi=false,%
									 chapterstyle@GreyNum=true,%
									 chapterstyle@texblogtikz=false,%
					 				 chapterstyle@acsei=false},
	loadextrachapsty/texblogtikz/.style={chapterstyle@daleifi=false,%
										 chapterstyle@GreyNum=false,%
										 chapterstyle@texblogtikz=true,%
					 					 chapterstyle@acsei=false},
	loadextrachapsty/acsei/.style={chapterstyle@daleifi=false,%
								   chapterstyle@GreyNum=false,%
								   chapterstyle@texblogtikz=false,%
					 			   chapterstyle@acsei=true},
	loadextrachapsty/.append code={\suacse@loadextrachapsty},
}

%% * Define chapter-style-related option keys
\pgfkeys{%
	/suacseopt/.cd,
	%% - Chapter style
	chapterstyle/.code={\suacseset{chapterstyle=#1}},
}

%% ! Note that in the nested \newcommand command, #1 is the first argument
%%   for the most outer one, and ##1 is the first argument for the next less
%%   outer one.
\newcommand{\suacse@loadextrachapsty}{%
\ifsuacse@chapterstyle@daleifi
	\RequirePackage{color,calc,graphicx,soul}
	\definecolor{nicered}{rgb}{.647,.129,.149}
	\newlength\dlf@normtxtw
	\setlength\dlf@normtxtw{\textwidth}
	\def\myhelvetfont{\def\sfdefault{mdput}}
	\newsavebox{\feline@chapter}
	\newcommand\feline@chapter@marker[1][4cm]{%
	  \sbox\feline@chapter{%
	    \resizebox{!}{##1}{\fboxsep=1pt%
	      \colorbox{nicered}{\color{white}\bfseries\sffamily\thechapter}%
	    }}%
	  \rotatebox{90}{%
	    \resizebox{%
	      \heightof{\usebox{\feline@chapter}}+\depthof{\usebox{\feline@chapter}}}%
	    {!}{\scshape\so\@chapapp}}\quad%
	  \raisebox{\depthof{\usebox{\feline@chapter}}}{\usebox{\feline@chapter}}% 
	}
	\newcommand\feline@chm[1][4cm]{%
	  \sbox\feline@chapter{\feline@chapter@marker[##1]}%
	  \makebox[0pt][l]{% aka \rlap
	    \makebox[1cm][r]{\usebox\feline@chapter}%
	  }}
	\makechapterstyle{daleifi}{
	  \renewcommand\chapnamefont{\normalfont\Large\scshape\raggedleft\so}
	  \renewcommand\chaptitlefont{\normalfont\huge\bfseries\scshape\color{nicered}}
	  \renewcommand\chapternamenum{}
	  \renewcommand\printchaptername{}
	  \renewcommand\printchapternum{\null\hfill\feline@chm[2.5cm]\par}
	  \renewcommand\afterchapternum{\par\vskip\midchapskip}
	  \renewcommand\printchaptertitle[1]{\chaptitlefont\raggedleft ####1\par}
	}
\fi
\ifsuacse@chapterstyle@GreyNum
	% \RequirePackage{fix-cm}
	% \RequirePackage{fourier}%................... Roman+math - Utopia
	\RequirePackage{color}
	\definecolor{ChapGrey}{rgb}{0.6,0.6,0.6}
	\newcommand{\LargeFont}{% Needs a 'stretchable' font
	      \usefont{\encodingdefault}{\rmdefault}{b}{n}%
	      \fontsize{60}{80}\selectfont\color{ChapGrey}}
	\makechapterstyle{GreyNum}{%
	  \renewcommand{\chapnamefont}{\large\sffamily\bfseries\itshape}
	  \renewcommand{\chapnumfont}{\LargeFont}
	  \renewcommand{\chaptitlefont}{\Huge\sffamily\bfseries\itshape}
	  \setlength{\beforechapskip}{0pt}
	  \setlength{\midchapskip}{40pt}
	  \setlength{\afterchapskip}{60pt}
	  \renewcommand\chapterheadstart{\vspace*{\beforechapskip}}
	  \renewcommand\printchaptername{%
	    \begin{tabular}{@{}c@{}}
	      \chapnamefont \@chapapp\\}
	    \renewcommand\chapternamenum{\noalign{\vskip 2ex}}
	    \renewcommand\printchapternum{\chapnumfont\thechapter\par}
	    \renewcommand\afterchapternum{%
	    \end{tabular}
	    \par\nobreak\vskip\midchapskip}
	  \renewcommand\printchapternonum{}
	  \renewcommand\printchaptertitle[1]{%
	    {\chaptitlefont{####1}\par}}
	  \renewcommand\afterchaptertitle{\par\nobreak\vskip \afterchapskip}
	}
\fi
\newif\ifnumberedchap
\numberedchaptrue
\ifsuacse@chapterstyle@texblogtikz
	% \newif\iftestii
	% \testiitrue
	% \iftestii
	% 	\typeout{iftestii is true.}
	% \else
	% 	\typeout{iftestii is false.}
	% \fi
	% \typeout{done!}
	\RequirePackage[svgnames]{xcolor}
	\RequirePackage{tikz}
	%% helper macros
	\newcommand{\ChapWithNumber}[1]{
	\begin{tikzpicture}[remember picture,overlay]
	    \node[yshift=-3cm] at (current page.north west)
	      {\begin{tikzpicture}[remember picture, overlay]
	        \draw[fill=LightSkyBlue] (0,0) rectangle
	          (\stockwidth,3cm);
	        \node[anchor=east,xshift=.9\stockwidth,rectangle,
	              rounded corners=20pt,inner sep=11pt,
	              fill=MidnightBlue]
	              {\color{white}\chapnamefont\thechapter\space ##1};
	       \end{tikzpicture}
	      };
	   \end{tikzpicture}
	}
	\newcommand{\ChapWithoutNumber}[1]{
	  \begin{tikzpicture}[remember picture,overlay]
	    \node[yshift=-3cm] at (current page.north west)
	    {\begin{tikzpicture}[remember picture, overlay]
	        \draw[fill=LightSkyBlue] (0,0) rectangle
	        (\stockwidth,3cm);
	        \node[anchor=east,xshift=.9\stockwidth,rectangle,
	        rounded corners=20pt,inner sep=11pt,
	        fill=MidnightBlue]
	        {\color{white}\chapnamefont##1};
	      \end{tikzpicture}
	    };
	  \end{tikzpicture}
	}
	% \newif\ifnumberedchap
	% \numberedchaptrue
	\makechapterstyle{texblogtikz}{
	  \renewcommand\chapnamefont{\normalfont\sffamily\Huge\bfseries}
	  \renewcommand\chapnumfont{\normalfont\sffamily\Huge\bfseries}
	  \renewcommand\chaptitlefont{\normalfont\sffamily\Huge\bfseries}
	  \renewcommand\chapternamenum{}
	  \renewcommand{\afterchapternum}{}
	  \renewcommand\printchaptername{}
	  \renewcommand\printchapternum{}
	  \renewcommand\printchapternonum{\global\numberedchapfalse}
	  \renewcommand\printchaptertitle[1]{%
	    \ifnumberedchap
	    \ChapWithNumber{####1}
	    \else
	    \ChapWithoutNumber{####1}
	    \fi
	    \global\numberedchaptrue
	  }
	}
\fi
\ifsuacse@chapterstyle@acsei
	% \RequirePackage{xcolor}  % Load Package 'xcolor'
	% \RequirePackage{tikz}  % Load Package 'tikz'
	% \providecommand\thesispage{\normalfont p.\,\thepage}
	% \providecommand\thesispage{\normalfont \colorbox{gray}%
	% 				{\color{white}p.\,\thepage}}
	% \providecommand\thesispage{\normalfont \tikz[baseline=0pt] %
	% 		\node[fill=black!75,text=white,anchor=base] {p.\,\thepage};}
	% \setlength{\headheight}{\baselineskip}
	% \setlength{\headwidth}{\textwidth+\marginparsep+0.5\marginparwidth}
	\makechapterstyle{acsei}{%
	  \setlength\beforechapskip{0pt}
	  \setlength\midchapskip{0pt}
	  \setlength\afterchapskip{40pt}
	  \renewcommand\chapnamefont{%
	    \normalfont\centering\large\scshape\MakeLowercase}
	  \renewcommand\chapnumfont{%
	    \normalfont\centering\fontsize{60pt}{0pt}\selectfont}
	  \renewcommand\chaptitlefont{%
	    \normalfont\HUGE\bfseries\centering}
	  \renewcommand\printchaptername{%
	    \marginpar{\chapnamefont{\@chapapp}}}
	  \renewcommand\chapternamenum{}
	  \renewcommand\printchapternum{%
	    \marginpar{\chapnumfont\thechapter}}
	    % \makeoddfoot{plain}{}{\thesispage}{}
		% 	  \if@mainmatter
		% \makerunningwidth{plain}{\headwidth}
		% \makeheadposition{plain}{flushright}{flushleft}{flushright}{flushleft}
		% \makeoddfoot{plain}{}{}{\thesispage}
		% 	  \else
		% \makeoddfoot{plain}{}{}{\thepage}
		% 	  \fi
	}
\fi
}

%% END: Chapter Styling
%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++


%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
%% Created by Dazhi Jiang, 2010-11-16 16:11:38 +0000 (Tue, 16 Nov 2010)
%% Section, etc., Styling

%% Set the default section number depth
\maxsecnumdepth{subsection} % number  subsections

%% * Define section-head-style-related keys
\pgfkeys{%
	/suacse/.cd,
	%% - Section head style
	headstyle/.code={\headstyles{#1}
					 \chapterstyle{\@suacse@chapter@style}},
	makeheadstyle/.code 2 args={\makeheadstyles{#1}{#2}},
	loadheadstyle/.is choice,
	loadheadstyle/memsty/.code={\suacse@loadheadstyle@memsty},
	loadheadstyle/wspr/.code={\suacse@loadheadstyle@wspr},
	loadheadstyle/acsei/.code={\suacse@loadheadstyle@acsei},
	secnumdepth/.code={\setsecnumdepth{#1}},
	maxsecnumdepth/.code={\maxsecnumdepth{#1}},
}

%% * Define section-head-style-related options keys


%% 
\newcommand{\suacse@loadheadstyle@memsty}{%
	\makeheadstyles{memsty}{%
		\defaultsecnum
		\memmansecheads
	}
}


\newcommand{\suacse@loadheadstyle@wspr}{%
	\newcommand\marginnum[2]{%
	  \noindent
	  \let\@tempa\relax
	  \savebox\@tempboxa{##2}%
	  %\null\marginpar{#1\@tempa}%
	  ##1\@tempa\quad##2}
	
	\makeheadstyles{wspr}{%
		\defaultsecheads
	
		\def\secstyle{\centering\scshape}
		\def\subsecstyle{\centering\itshape}
		\def\subsubsecstyle{\centering\small\itshape}
	
		\setsecheadstyle{\marginnum\secstyle}
		\setsubsecheadstyle{\marginnum\subsecstyle}
		\setsubsubsecheadstyle{\marginnum\subsubsecstyle}
	
		\setsecnumformat{\unexpanded{%
		  \protected@xdef\@tempa{{\upshape\S \csname the####1\endcsname}}}}
	}
}


\newcommand{\suacse@loadheadstyle@acsei}{%
	\newcommand\marginnum[2]{%
	  \noindent
	  \let\@tempa\relax
	  \savebox\@tempboxa{##2}%
	  %\null\marginpar{#1\@tempa}%
	  ##1\@tempa##2}
	\makeheadstyles{acsei}{%
		\defaultsecnum
		
		\def\secstyle{\Large\bfseries\raggedright}
		\def\subsecstyle{\large\bfseries\raggedright}
		\def\subsubsecstyle{\bfseries\raggedright}
	
		\setsecheadstyle{\normalfont\marginnum\secstyle}
		\setsubsecheadstyle{\normalfont\marginnum\subsecstyle}
		\setsubsubsecheadstyle{\normalfont\marginnum\subsubsecstyle}
		  \setsubsubsecindent{0pt}
		
		\setsecnumformat{\unexpanded{%
		  \protected@xdef\@tempa{{\upshape\S\,\csname the####1\endcsname\quad}}}}
	}
}
%% !!! A few comment
%% The original command \marginnum puts the \quad into \@tempa. This can cause
%% unexpected extra spaces when print the unnumbered section head. The solution
%% is to move \quad to the definition of \@seccntformat which can be changed
%% using \setsecnumformat



%% * Command used to set the default head style
\newcommand*{\defaultsecheads}{
  \defaultsecnum
  \setsecheadstyle{\normalfont\Large\bfseries\raggedright}
    \setsecindent{0pt}
    \setbeforesecskip{-3.5ex plus -1ex minus -.2ex}
    \setaftersecskip{2.3ex plus .2ex}
  \setsubsecheadstyle{\normalfont\large\bfseries\raggedright}
    \setsubsecindent{0pt}
    \setbeforesubsecskip{-3.25ex plus -1ex minus -.2ex}
    \setaftersubsecskip{1.5ex plus .2ex}
  \setsubsubsecheadstyle{\normalfont\bfseries\raggedright}
    \setsubsubsecindent{0pt}
    \setbeforesubsubsecskip{-3.25ex plus -1ex minus -.2ex}
    \setaftersubsubsecskip{1.5ex plus .2ex}
  \setparaheadstyle{\normalfont\bfseries}
    \setparaindent{0pt}
    \setbeforeparaskip{3.25ex plus 1ex minus .2ex}
    \setafterparaskip{-1em}
  \setsubparaheadstyle{\normalfont\bfseries}
    \setsubparaindent{0pt}
    \setbeforesubparaskip{3.25ex plus 1ex minus .2ex}
    \setaftersubparaskip{-1em}
}

%% * Memoir manual section head style
\newcommand*{\memmansecheads}{
  \setsecheadstyle{\normalfont\scshape\raggedright}
    \setsecindent{0pt}
    \setbeforesecskip{-1.333\onelineskip plus -0.5\onelineskip minus -0.5\onelineskip}
    \setaftersecskip{.667\onelineskip plus 0.1\onelineskip}
%%% surround = 2 lines (1.333/.667)
%%% surround = 1 line (.667/.333)
  \setsubsecheadstyle{\normalfont\sffamily\raggedright}
    \setsubsecindent{0pt}
    \setbeforesubsecskip{-.667\onelineskip plus -0.5\onelineskip minus -0.5\onelineskip}
    \setaftersubsecskip{0.333\onelineskip plus 0.1\onelineskip}
%%% surround = 1 line (.667/.333)
  \setsubsubsecheadstyle{\normalfont\itshape\raggedright}
    \setsubsubsecindent{0pt}
    \setbeforesubsubsecskip{-0.667\onelineskip plus -0.25\onelineskip minus -0.25\onelineskip}
    \setaftersubsubsecskip{0.333\onelineskip plus 0.1\onelineskip}
%%% no surround
  \setparaheadstyle{\normalfont\sffamily}
    \setparaindent{0pt}
    \setbeforeparaskip{1.0\onelineskip plus 0.5\onelineskip minus 0.25\onelineskip}
    \setafterparaskip{-1em}
  \setsubparaheadstyle{\normalfont\sffamily}
    \setsubparaindent{0pt}
    \setbeforesubparaskip{1.0\onelineskip plus 0.5\onelineskip minus 0.25\onelineskip}
    \setaftersubparaskip{-1em}
}


%% END: Section, etc., Styling
%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++


%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
%% Created by Dazhi Jiang, 2010-11-16 16:12:17 +0000 (Tue, 16 Nov 2010)
%% Captions

%% END: Captions
%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++


%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
%% Created by Dazhi Jiang, 2010-11-16 16:12:36 +0000 (Tue, 16 Nov 2010)
%% Bibliography

%% END: Bibliography
%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++


%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
%% Created by Dazhi Jiang, 2010-11-16 16:03:18 +0000 (Tue, 16 Nov 2010)
%% Fonts

%% * Switchers for fonts
\newif\ifsuacseopt@font@cm			% Computer Modern
\newif\ifsuacseopt@font@ppl		% Palatino
\newif\ifsuacseopt@font@memfonts	% Hybrid of Palatino and Computer Modern, memfonts

%% * Define font-related keys
\pgfkeys{%
	/suacseopt/.cd,
	%% - Font
	font@cm/.is if=suacseopt@font@cm,
	font@ppl/.is if=suacseopt@font@ppl,
	font@memfonts/.is if=suacseopt@font@memfonts,
	font/.is choice,
	font/cm/.style={font@cm=true, font@ppl=false, font@memfonts=false},
	font/ppl/.style={font@cm=false, font@ppl=true, font@memfonts=false},
	font/memfonts/.style={font@cm=false, font@ppl=false, font@memfonts=true},
	font/.default=cm,
	font/.append code={\suacseopt@setfont},
	% font/.code={\suacseset{font=#1}},
}

%% * Load the commonly-used packages
\RequirePackage[T1]{fontenc} % sane font encoding

\RequirePackage{textcomp} % provide lots of new symbols
\RequirePackage{lmodern} % for sensible sans and tt font

% \renewcommand{\suacseopt@setfont}{%
\newcommand{\suacseopt@setfont}{%
	%% Palatino
	\ifsuacseopt@font@ppl
		\RequirePackage[sc,osf]{mathpazo}  % Load Package 'mathpazo'
		% \RequirePackage{mathpazo}
		\renewcommand{\rmdefault}{ppl} 
		% \renewcommand{\oldstylenums}[1]{{\fontfamily{pplj}\selectfont #1}}
	\fi
	
	%% Memoir Manual Font Style
	\ifsuacseopt@font@memfonts
		\RequirePackage{memfonts}  % Load Package 'memfonts'
	\fi
}
\@onlypreamble\suacseopt@setfont

\RequirePackage{pifont}  % Load Package 'pifont'
\newcommand\diameter{\Pisymbol{psy}{'306}} % Define new symbol

%% * Make maths use lining numbers: (old-style look bad most-times)
\DeclareMathSymbol{0}{0}{letters}{'060}
\DeclareMathSymbol{1}{0}{letters}{'061}
\DeclareMathSymbol{2}{0}{letters}{'062}
\DeclareMathSymbol{3}{0}{letters}{'063}
\DeclareMathSymbol{4}{0}{letters}{'064}
\DeclareMathSymbol{5}{0}{letters}{'065}
\DeclareMathSymbol{6}{0}{letters}{'066}
\DeclareMathSymbol{7}{0}{letters}{'067}
\DeclareMathSymbol{8}{0}{letters}{'070}
\DeclareMathSymbol{9}{0}{letters}{'071}

%% * Use Latin Modern for other fonts
\renewcommand{\sfdefault}{lmss}
\renewcommand{\ttdefault}{lmtt}

%%   - scaled version of t1lmtt

\DeclareFontFamily{T1}{lmtt}{\hyphenchar \font\m@ne}
\DeclareFontShape{T1}{lmtt}{m}{n}
  {<-8.5> s * [1.09] ec-lmtt8 <8.5-9.5> s * [1.09] ec-lmtt9
   <9.5-11> s * [1.09] ec-lmtt10 <11-> s * [1.09] ec-lmtt12
  }{}

\DeclareFontShape{T1}{lmtt}{m}{sl}
  {<-> s * [1.09] ec-lmtto10}{}
\DeclareFontShape{T1}{lmtt}{m}{it}
  {<-> s * [1.09] ec-lmtti10}{}
\DeclareFontShape{T1}{lmtt}{m}{sc}
  {<-> s * [1.09] ec-lmtcsc10}{}
\DeclareFontShape{T1}{lmtt}{m}{scsl}
  {<-> s * [1.09] ec-lmtcso10}{}
%%%% light (l), light condensed (lc), and dark (b) variants
\DeclareFontShape{T1}{lmtt}{l}{n}
  {<-> s * [1.09] ec-lmtl10}{}
\DeclareFontShape{T1}{lmtt}{l}{sl}
  {<-> s * [1.09] ec-lmtlo10}{}
\DeclareFontShape{T1}{lmtt}{l}{it}
  {<->sub*lmtt/l/sl}{}

\DeclareFontShape{T1}{lmtt}{lc}{n}
  {<-> s * [1.09] ec-lmtlc10}{}
\DeclareFontShape{T1}{lmtt}{lc}{sl}
  {<-> s * [1.09] ec-lmtlco10}{}
\DeclareFontShape{T1}{lmtt}{lc}{it}
  {<->sub*lmtt/lc/sl}{}

\DeclareFontShape{T1}{lmtt}{b}{n}
  {<-> s * [1.09] ec-lmtk10}{}
\DeclareFontShape{T1}{lmtt}{b}{sl}
  {<-> s * [1.09] ec-lmtko10}{}
\DeclareFontShape{T1}{lmtt}{b}{it}
  {<->sub*lmtt/b/sl}{}

\DeclareFontShape{T1}{lmtt}{bx}{n}
  {<->ssub*lmtt/b/n}{}
\DeclareFontShape{T1}{lmtt}{bx}{sl}
  {<->ssub*lmtt/b/sl}{}
\DeclareFontShape{T1}{lmtt}{bx}{it}
  {<->ssub*lmtt/b/sl}{}


%%   - scaled version of t1lmss

\DeclareFontFamily{T1}{lmss}{}
\DeclareFontShape{T1}{lmss}{m}{n}
  {<-8.5> s * [1.07] ec-lmss8 <8.5-9.5> s * [1.07] ec-lmss9
   <9.5-11> s * [1.07] ec-lmss10 <11-15.5> s * [1.07] ec-lmss12
   <15.5-> s * [1.07] ec-lmss17
  }{}
\DeclareFontShape{T1}{lmss}{m}{sl}
  {<-8.5> s * [1.07] ec-lmsso8 <8.5-9.5> s * [1.07] ec-lmsso9
   <9.5-11> s * [1.07] ec-lmsso10 <11-15.5> s * [1.07] ec-lmsso12
   <15.5-> s * [1.07] ec-lmsso17
  }{}
\DeclareFontShape{T1}{lmss}{m}{it}
  {<->ssub*lmss/m/sl}{}
\DeclareFontShape{T1}{lmss}{m}{sc}
  {<->sub*lmr/m/sc}{}

%%%%%%%%%%% semibold condensed
\DeclareFontShape{T1}{lmss}{sbc}{n}
  {<-> s * [1.07] ec-lmssdc10}{}
\DeclareFontShape{T1}{lmss}{sbc}{sl}
  {<-> s * [1.07] ec-lmssdo10}{}
\DeclareFontShape{T1}{lmss}{sbc}{it}
  {<->ssub*lmss/sbc/sl}{}

%%%%%%%%%%%% bold extended
\DeclareFontShape{T1}{lmss}{bx}{n}
  {<-> s * [1.07] ec-lmssbx10}{}
\DeclareFontShape{T1}{lmss}{bx}{sl}
  {<-> s * [1.07] ec-lmssbo10}{}
\DeclareFontShape{T1}{lmss}{bx}{it}
  {<->ssub*lmss/bx/sl}{}


%% END: Fonts
%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++


%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
%% Created by Dazhi Jiang, 2010-11-18 13:11:44 +0000 (Thu, 18 Nov 2010)
%% Declare Package Options
%%   - Declare pgf package options
%%     Note that the command,\ProcessPgfPackageOptions, has to be put
%%     an proper place, see below,
%%     1. This declaration command has to be put after all \pgfkeys
%%     2. If the <if> keys are used directly, this command has to be put
%%        somewhere before the commands that include the <if> keys. This is
%%        because that the <if> keys are set in this command and will take
%%        the default value if the command is used after the <if> keys.
%%     3. Any command used by keys has to be defined before the declaration.
%%        You can define an empty command in advance, do the declaration
%%        and then renew it.
%%     4. Avoid to use the <if> keys directly. If necessary, define a new
%%        command within which the <if> keys is used and include this command
%%        into a key, /path/key/.append code.
\ProcessPgfPackageOptions{/suacseopt}
%% END: Declare Package Options
%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++


%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
%% Created by Dazhi Jiang, 2010-11-17 14:05:56 +0000 (Wed, 17 Nov 2010)
%% Initialise Keys

%% * Setting-up the default options
\pgfkeys{%
	/suacse/.cd,
	spacing=onehalf,
	% pagelayout=acseii,
	% font=cm,
	% loadextrachapsty=acsei,
}

\pgfkeys{%
	/suacseopt/.cd,
	spacing=onehalf,
	pagelayout=acseii,
	font=cm,
	% chapterstyle=acsei
}

%% END: Initialise Keys
%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++


%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
%% Created by Dazhi Jiang, 2010-11-16 16:42:17 +0000 (Tue, 16 Nov 2010)
%% Commands
% \RequirePackage{amsmath,amssymb,bm,cool,mathtools}
\RequirePackage{amsmath}  % Load Package 'amsmath'
\RequirePackage{amssymb}  % Load Package 'amssymb'
\RequirePackage{bm}  % Load Package 'bm'
\RequirePackage{cool}  % Load Package 'cool'
\RequirePackage{mathtools}  % Load Package 'mathtools'

%% For COOL
%% * Brilliant Definition!
%%   This gives a nested integrate, that is,
%%     \Integrate{f(x,y,z,t)}{t}{x}{y}{z}
%%   gives a fourth-order integrate
\let\orig@Integrate\Integrate
\renewcommand\Integrate[2]{%
  \@ifnextchar\bgroup
    {\Integrate{\orig@Integrate{#1}{#2}}}
    {\orig@Integrate{#1}{#2}}}
\let\Int\Integrate

%% END: Commands
%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++


%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
%% Created by Dazhi Jiang, 2010-11-18 11:59:23 +0000 (Thu, 18 Nov 2010)
%% MISC

%% END: MISC
%% ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++


\endinput
